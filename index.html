/* ══════════════════════════════════════════
   API SERVICE — Proxy via Render
══════════════════════════════════════════ */
const API = {
  BASE: 'https://football-recommendations.onrender.com', // החיבור לשרת שלך!

  async req(path) {
    const r = await fetch(this.BASE + path);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  },

  live(sport)           { return this.req(`/api/v1/sport/${sport}/events/live`); },
  sched(sport, date)    { return this.req(`/api/v1/sport/${sport}/scheduled-events/${date}`); },
  stats(id)             { return this.req(`/api/v1/event/${id}/statistics`).catch(()=>null); },
  lineups(id)           { return this.req(`/api/v1/event/${id}/lineups`).catch(()=>null); },
  h2h(id)               { return this.req(`/api/v1/event/${id}/h2h`).catch(()=>null); },
  teamEvents(teamId)    { return this.req(`/api/v1/team/${teamId}/events/last/0`).catch(()=>null); },
};

// ... השאר את const AI ו-const FAKE ללא שינוי ...

// בתוך const App = { ... } ודא שהקוד הזה מחליף את המקורי:
  TARGET_LEAGUES: [
    'Premier League', 'LaLiga', 'Ligue 1', 'Serie A',
    'Ligat HaAl', 'State Cup', 'Toto Cup',
    'NBA', 'Super League', 'National League'
  ],

  isTargetLeague(ev) {
    const lg = ev.tournament?.name || ev.league?.name || '';
    const ctry = ev.tournament?.category?.name || '';
    return this.TARGET_LEAGUES.some(l => lg.includes(l)) || ctry.toLowerCase() === 'israel';
  },

  async refresh() {
    this.setStatus('SYNCING', null);
    try {
      const sport = this.sport === 'soccer' ? 'football' : 'basketball';
      const live = await API.live(sport);
      const evs = (live?.events || []).filter(e => this.isTargetLeague(e));
      if (evs.length > 0) {
        this.all = evs.map(e => this.cook(e, true));
        this.usingFake = false;
        this.setMode(true);
        this.setStatus('LIVE', 'green');
      } else {
        await this.upcoming(sport);
      }
    } catch(e) {
      try {
        const sport = this.sport === 'soccer' ? 'football' : 'basketball';
        await this.upcoming(sport);
      } catch(e2) {
        this.loadFake();
      }
    }
    this.shown = [...this.all];
    this.renderList();
    if (this.sel !== null && this.sel < this.shown.length) {
      this.select(this.sel, true);
    }
  },

  async upcoming(sport) {
    const today = new Date();
    let allFuture = [];
    let loaded = false;

    for (let i = 0; i <= 7; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() + i);
      const ds = d.toISOString().split('T')[0];
      try {
        const data = await API.sched(sport, ds);
        const evs = (data?.events || []).filter(e => this.isTargetLeague(e));
        if (evs.length > 0) {
          allFuture = allFuture.concat(evs);
          if (allFuture.length >= 5) {
            this.all = allFuture.slice(0, 30).map(e => this.cook(e, false));
            this.usingFake = false;
            this.setMode(false);
            this.setStatus(i===0 ? 'TODAY' : `+${i}D`, 'cyan');
            loaded = true;
            break;
          }
        }
      } catch(e) {}
    }

    if (!loaded && allFuture.length > 0) {
        this.all = allFuture.slice(0, 30).map(e => this.cook(e, false));
        this.usingFake = false;
        this.setMode(false);
        this.setStatus('UPCOMING', 'cyan');
        loaded = true;
    }

    if (!loaded) throw new Error('no events');
  },
